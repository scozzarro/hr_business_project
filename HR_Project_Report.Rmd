---
title: "HR data analysis and contract termination prediction"
author: "Gabriel Scozzarro"
Date: "26/12/2020"
output: pdf_document
mainfont: Arial
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1.0 Introduction


````{r lib & tools, warning = FALSE, error = FALSE, message = FALSE, echo = FALSE}
library(tidyverse)
library(corrplot)
library(kableExtra)
library(scales)
library(lubridate)
library(reshape2)
library(plyr)
library(RColorBrewer)

nb.cols <- 26
mycolors <- colorRampPalette(brewer.pal(8, "Set2"))(nb.cols)

````

## 2.0 Preparation and reading data
Data was imported from the set contained inside the file HRDataset_v14.csv

````{r import data, echo = FALSE}
hr_data<- read.csv("Data/HRDataset_v14.csv")
````


````{r summary, echo = FALSE}
feature_desc<- c('Employee’s full name', 'Employee ID is unique to each employee', 'Is the person married (1 or 0 for yes or no)',
                 'Marital status code that matches the text field MaritalDesc','Gender ID that mathces Sex', 'Employment status code that matches text field EmploymentStatus', 'Department ID code that matches the department the employee works in', 'Performance Score code that matches the employee’s most recent performance score', 'Was the employee sourced from the Diversity job fair? 1 or 0 for yes or no','The person’s annual pay rate', 'Has this employee been terminated - 1 or 0', 'An integer indicating the person’s position','The text name/title of the position the person has','The state that the person lives in','The zip code for the employee', 'Date of Birth for the employee','Sex - M or F', 'The marital status of the person (divorced, single, widowed, separated, etc)', 'Label for whether the person is a Citizen or Eligible NonCitizen', 'Yes or No field for whether the employee is Hispanic/Latino', 'Description/text of the race the person identifies with', 'Date the person was hired', 'Date the person was terminated, only populated if, in fact, Termd = 1', 'A text reason / description for why the person was terminated'	, 'A description/category of the person’s employment status. Anyone currently working full time = Active', 'Name of the department that the person works in', 'The name of the person’s immediate manager', 'A unique identifier for each manager', 'The name of the recruitment source where the employee was recruited from','Performance Score text/category (Fully Meets, Partially Meets, PIP, Exceeds)','Results from the last engagement survey, managed by our external partner', 'A basic satisfaction score between 1 and 5, as reported on a recent employee satisfaction survey', 'The number of special projects that the employee worked on during the last 6 months','The most recent date of the person’s last performance review', 'The number of times that the employee was late to work during the last 30 days', 'The number of times the employee was absent from work')

feature_type<- c('Text','Text','Binary','Integer','Binary','Integer','Integer','Integer','Binary','Float','Binary','Integer','Text','Text','Text','Date','Text','Text','Text','Text','Text','Date','Date','Text','Text','Text','Text',
'Integer','Text','Text','Float','Integer','Integer','Date','Integer','Integer')

glimpse_data<- data.frame(Feature = colnames(hr_data), Description = feature_desc, Type = feature_type)

glimpse_data %>% kable('latex', digits = 10, caption = 'Data summary table', booktabs = T) %>% kable_styling(full_width = FALSE, font_size = 11, latex_options = c("striped", 'condensed','scale_down')) %>% column_spec(3, width = "12em")

summary_data<- summary(hr_data)

summary_data[,1:9] %>% kable('latex', digits = 10, booktabs = T) %>% kable_styling(full_width = FALSE, font_size = 11, latex_options = c("striped", 'condensed','scale_down'))
summary_data[,10:18] %>% kable('latex', digits = 10, booktabs = T) %>% kable_styling(full_width = FALSE, font_size = 11, latex_options = c("striped", 'condensed','scale_down'))
summary_data[,19:27] %>% kable('latex', digits = 10, booktabs = T) %>% kable_styling(full_width = FALSE, font_size = 11, latex_options = c("striped", 'condensed','scale_down'))
summary_data[,28:36] %>% kable('latex', digits = 10, booktabs = T) %>% kable_styling(full_width = FALSE, font_size = 11, latex_options = c("striped", 'condensed','scale_down'))
````

````{r fixing, echo = FALSE}
hr_data$ManagerID[is.na(hr_data$ManagerID)]<- 0

hr_data$MaritalDesc<- as_factor(hr_data$MaritalDesc)

useless_col<- c("GenderID", "MaritalStatusID")
hr_data<- hr_data[, -which(colnames(hr_data) %in% useless_col)]

hr_data$DateofHire<- as.POSIXlt(hr_data$DateofHire,format="%m/%d/%Y")
hr_data$DateofHire<- as.Date(hr_data$DateofHire)

hr_data$DateofTermination<- as.POSIXlt(hr_data$DateofTermination,format="%m/%d/%Y")
hr_data$DateofTermination<- as.Date(hr_data$DateofTermination)

hr_data$DOB<- as.Date(hr_data$DOB, "%m/%d/%y")
hr_data$DOB<- as.Date(ifelse(hr_data$DOB > "2020-01-01", format(hr_data$DOB, "19%y-%m-%d"), format(hr_data$DOB)))

hr_data$Age<- year(Sys.Date())-year(hr_data$DOB)
````
The total amount of employees are 311 and 36 features was collected for each of them.

## 3.0 EDA
### 3.1 Gender analysis
````{r gender analysis I, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE }
hr_data %>% ggplot(aes(Sex, fill = Sex)) +
            geom_bar(stat = "count") +
            ggtitle("Gender presence") +
            theme_minimal() +
            theme(legend.position =  "none")

  
hr_data %>% ggplot(aes(Age, fill = Sex)) +
            geom_density(alpha = 0.3) +
            theme_minimal()

all_roles = unique(hr_data$Position)
hr_data$Position = factor(hr_data$Position, levels = all_roles)
hr_data$order = as.numeric(hr_data$Position)/100 

hr_data %>% filter(!is.na(DateofTermination)) %>%
            ggplot(aes(x = factor(order), fill = Sex)) + 
            geom_bar(subset=.(Sex == "M")) + 
            geom_bar(subset=.(Sex == "F"), aes(y=..count..)) + 
            scale_x_discrete(labels = all_roles) +
            xlab("Role") +
            coord_flip() +
            theme(text = element_text(size = 16)) +
            ggtitle("Gender presence by role up to date") +
            theme_minimal()
````
The company has a majority presence of women (176) compare to men (135) with a very close average age of respectively 42.5 for women and  42.3 for men. Regardless the average age we can see that the age distribution is shift to the left for both men and women meaning that the the majority of the employees are younger compare to the average age.

The company has a large an prevalent presence of women employed in the production as Product Technician I and Product Technician II. Managerial roles also has a 100% prevalence of women guiding fundamental aspects such as software engineering, sales and production. 
````{r gender analysis II, echo = FALSE, out.height= '100%', warning = FALSE, error = FALSE, message = FALSE }

hr_data %>% filter(year(DateofHire)<= 2009) %>%
            ggplot(aes(x = factor(order), fill = Sex)) + 
            geom_bar(subset=.(Sex == "M")) + 
            geom_bar(subset=.(Sex == "F"), aes(y=..count..)) + 
            scale_x_discrete(labels = all_roles) +
            xlab("Role") +
            coord_flip() +
            theme(text = element_text(size = 16)) +
            facet_wrap(~year(DateofHire)) +
            ggtitle("Enrolment by role and gender 2006 - 2009") +
            theme_minimal()
            
hr_data %>% filter(year(DateofHire)>= 2010  & year(DateofHire)<= 2013) %>%
            ggplot(aes(x = factor(order), fill = Sex)) + 
            geom_bar(subset=.(Sex == "M")) + 
            geom_bar(subset=.(Sex == "F"), aes(y=..count..)) + 
            scale_x_discrete(labels = all_roles) +
            xlab("Role") +
            coord_flip() +
            theme(text = element_text(size = 16)) +
            facet_wrap(~year(DateofHire)) +
            ggtitle("Enrolment by role and gender 2010 - 2013") +
            theme_minimal()

hr_data %>% filter(year(DateofHire)>= 2014  & year(DateofHire)<= 2016) %>%
            ggplot(aes(x = factor(order), fill = Sex)) + 
            geom_bar(subset=.(Sex == "M")) + 
            geom_bar(subset=.(Sex == "F"), aes(y=..count..)) + 
            scale_x_discrete(labels = all_roles) +
            xlab("Role") +
            coord_flip() +
            theme(text = element_text(size = 16)) +
            facet_wrap(~year(DateofHire)) +
            ggtitle("Enrolment by role and gender 2014 - 2016") +
            theme_minimal()

hr_data %>% filter(year(DateofHire)> 2016) %>%
            ggplot(aes(x = factor(order), fill = Sex)) + 
            geom_bar(subset=.(Sex == "M")) + 
            geom_bar(subset=.(Sex == "F"), aes(y=..count..)) + 
            scale_x_discrete(labels = all_roles) +
            xlab("Role") +
            coord_flip() +
            theme(text = element_text(size = 16)) +
            facet_wrap(~year(DateofHire)) +
            ggtitle("Enrolment by role and gender 2017 - 2018") +
            theme_minimal()


hr_data %>% group_by(Sex, year = year(DateofHire)) %>%
            dplyr::summarise(n = n()) %>%
            ggplot(aes(year, n, color = Sex)) +
            geom_line(aes(linetype=Sex), size = 1) +
            geom_point(size = 2) +
            ggtitle("Hiring trend by gender") +
            theme_minimal()
````

````{r gender analysis III, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE }

hr_data %>% group_by(Sex, Position) %>%
            dplyr::summarise(avgsal = mean(Salary)) %>%
            ggplot(aes(avgsal, Position, fill = Sex)) +
            geom_bar(stat = "identity", position = "dodge") +
            ggtitle("Average salary by gender and role") +
            theme_minimal()

hr_data %>% filter(!is.na(DateofTermination)) %>%
            group_by(Sex) %>%
            dplyr::summarise(n = n()) %>%
            ggplot(aes(n, Sex, fill = Sex)) +
            geom_bar(stat = "identity") +
            ggtitle("Employes contract terminated by gender") +
            theme_minimal() +
            theme(legend.position = "none")

hr_data %>% group_by(Sex, RecruitmentSource) %>%
            dplyr::summarise(n = n()) %>%
            ggplot(aes(n, RecruitmentSource, fill = Sex)) +
            geom_bar(stat = "identity", position = "dodge") +
            ggtitle("Recruitment source performance by gender") +
            theme_minimal()

hr_data %>% filter(!is.na(DateofTermination)) %>%
            group_by(Sex, TermReason) %>%
            dplyr::summarise(n = n()) %>%
            ggplot(aes(n, TermReason, fill = Sex)) +
            geom_bar(stat = "identity", position = "dodge") +
            ggtitle("Contract termination reasons by gender") +
            theme_minimal()


hr_data %>% group_by(Sex) %>%
            ggplot(aes(Sex, EmpSatisfaction, fill = Sex)) +
            geom_violin(width=1, alpha = 0.7) +
            geom_boxplot(width=0.1, color="black", alpha=0.2) +
            theme_minimal() +
            theme(legend.position="none") +
            ggtitle("Employes satisfaction by gender")

hr_data$Salary_level<- 0

for (i in 1:nrow(hr_data)) {
  if (hr_data$Salary[i] > mean(hr_data$Salary) + 2*sd(hr_data$Salary)) {
    hr_data$Salary_level[i]<- "High"
  }
  else if (hr_data$Salary[i] < mean(hr_data$Salary) + sd(hr_data$Salary)) {
    hr_data$Salary_level[i]<- "Medium"
  } 
  else {
    hr_data$Salary_level[i]<- "Low"
  }
  }

hr_data %>% group_by(Sex, Salary_level) %>%
            ggplot(aes(Salary_level, EmpSatisfaction, fill = Sex)) +
            geom_boxplot() +
            ggtitle("Employes satisfaction level by gender and salary level")

````

### 3.2 Manager and performance analysis
In the next part managers and relative performance was analyzed.
Company has `r length(unique(hr_data$ManagerName))` different managers listed as follow:

````{r Manager perf analysis, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE }
kable(unique(hr_data$ManagerName), format = 'latex', digits = 7, caption = "Manager list", booktabs = T, longtable = T) %>%
  kable_styling(full_width = FALSE, font_size = 7, position = "left", latex_options = c('striped', 'condensed','scale_down'))

hr_data %>% ggplot(aes(ManagerName, fill = ManagerName)) +
            geom_bar() +
            geom_text(stat='count', aes(label=..count..), vjust = 0) +
            scale_fill_manual(values = mycolors) +
            coord_flip() +
            ggtitle('Employees under each manager') +
            theme_minimal() +
            theme(legend.position = 'none')

hr_data %>% ggplot(aes(PerformanceScore, fill = PerformanceScore)) +
            geom_bar() +
            geom_text(stat='count', aes(label=..count..), vjust=-0.2) +
            facet_wrap(~ManagerName) +
            theme(axis.text.x=element_blank(), legend.text = element_text(size=6), legend.title = element_text(size=6)) +
            ggtitle('Employess performance by manager')

hr_data %>% filter(EmploymentStatus != 'Active') %>%
            ggplot(aes(TermReason, fill = TermReason)) +
            geom_bar() +
            geom_text(stat='count', aes(label=..count..), vjust=0, nudge_y = 0.5) +
            facet_wrap(~ManagerName) +
            scale_fill_manual(values = mycolors) +
            theme(axis.text.x=element_blank(), legend.text = element_text(size=6), legend.title = element_text(size=6)) +
            ggtitle('Termination reason by manager')

hr_data %>% group_by(ManagerName) %>%
            dplyr::summarise(Special_Projects = sum(SpecialProjectsCount)) %>%
            ggplot(aes(Special_Projects, ManagerName, fill = ManagerName)) +
            geom_bar(stat = 'identity') +
            geom_text(aes(label=Special_Projects, vjust=0.5)) +
            scale_fill_manual(values = mycolors) +
            ggtitle('Special projects by manager') +
            theme_minimal() +
            theme(legend.position = 'none')

hr_data %>% group_by(ManagerName) %>%
            dplyr::summarise(avgsatisf = mean(EmpSatisfaction)) %>%
            ggplot(aes(sort(avgsatisf, decreasing = F), ManagerName, fill = ManagerName)) +
            geom_bar(stat = 'identity') +
            xlab('Average Satisfaction') +
            scale_fill_manual(values = mycolors) +
            ggtitle('Average employees satisfaction by manager') +
            theme_minimal() +
            theme(legend.position = 'none')

````
\pagebreak

### 3.3 Termination for salary analysis
In the next part the correlation between salary and employees whom terminated the contract for more money reasons.


````{r Termination for salary analysis, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE }
#Termination for salary analysis ----
hr_data %>% filter(TermReason == 'more money') %>% 
            group_by(Position) %>% 
            dplyr::summarise(n = n()) %>%
            ggplot(aes(n, Position, fill = Position)) +
            geom_bar(stat = 'identity') +
            scale_fill_manual(values = mycolors) +
            ggtitle('Postion and quantity terminated for more money') +
            theme_minimal()

hr_data %>% filter(TermReason == 'more money') %>%
            group_by(Position) %>% 
            dplyr::summarise(avgsatisfaction = mean(EmpSatisfaction)) %>%
            ggplot(aes(avgsatisfaction, Position, fill = Position)) +
            geom_bar(stat = 'identity') +
            scale_fill_manual(values = mycolors) +
            ggtitle('Employees satisfaction which terminated') +
            theme_minimal()

termpos<- unique(as.character(hr_data$Position[which(hr_data$TermReason == 'more money')]))

avgsal_active<- hr_data %>% group_by(Position) %>%
                filter(EmploymentStatus == 'Active') %>%
                dplyr::summarise(avgsal = mean(Salary)) %>%
                filter(Position %in% termpos)

avgsal_terminated<- hr_data %>% group_by(Position) %>%
                    filter(EmploymentStatus != 'Active') %>%
                    dplyr::summarise(avgsal = mean(Salary)) %>%
                    filter(Position %in% termpos)

avgsal_active$status<- c('Active','Active')
avgsal_terminated$status<- c('Terminated','Terminated')

avsal_frame<- full_join(x = avgsal_active, y = avgsal_terminated)

avsal_frame %>% ggplot(aes(avgsal, Position, fill = status)) +
                geom_bar(stat = 'identity', position = 'dodge') +
                scale_fill_manual(values = mycolors) +
                ggtitle('Salary difference between active employees and whom terminted for more money') +
                theme_minimal()

hr_data %>% group_by(RecruitmentSource) %>%
            dplyr::summarise(avgsal = mean(Salary)) %>%
            ggplot(aes(sort(avgsal, decreasing = F), RecruitmentSource, fill = RecruitmentSource)) +
            geom_bar(stat = 'identity') +
            xlab('Average salary') +
            scale_fill_manual(values = mycolors) +
            ggtitle('Salary by recruitment source') +
            theme_minimal()
````

